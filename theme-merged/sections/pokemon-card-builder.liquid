{% comment %}
  Pokemon Card Collection Builder Section
  Allows users to build custom card collection pages
{% endcomment %}

<style>
  .card-builder-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4rem 2rem;
    text-align: center;
    margin-bottom: 3rem;
  }
  
  .card-builder-hero h1 {
    font-size: 3rem;
    font-weight: 800;
    margin-bottom: 1rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  
  .card-builder-hero p {
    font-size: 1.25rem;
    margin-bottom: 2rem;
    opacity: 0.9;
  }
  
  .builder-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 2rem;
  }
  
  .builder-option {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    text-align: center;
  }
  
  .builder-option:hover {
    transform: translateY(-8px);
    box-shadow: 0 16px 48px rgba(0,0,0,0.15);
  }
  
  .option-preview {
    width: 120px;
    height: 90px;
    margin: 0 auto 1.5rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    display: grid;
    gap: 2px;
    padding: 8px;
    background: #f9fafb;
  }
  
  .preview-3x3 {
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
  }
  
  .preview-4x3 {
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(3, 1fr);
  }
  
  .preview-card {
    background: #3b82f6;
    border-radius: 2px;
  }
  
  .option-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.5rem;
  }
  
  .option-description {
    color: #6b7280;
    margin-bottom: 1.5rem;
    line-height: 1.6;
  }
  
  .option-features {
    list-style: none;
    padding: 0;
    margin-bottom: 2rem;
  }
  
  .option-features li {
    color: #10b981;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }
  
  .option-features li:before {
    content: "✓ ";
    font-weight: bold;
    margin-right: 0.5rem;
  }
  
  .create-page-btn {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease;
    width: 100%;
  }
  
  .create-page-btn:hover {
    transform: scale(1.05);
  }
  
  .how-it-works {
    max-width: 800px;
    margin: 4rem auto 0;
    padding: 0 2rem;
  }
  
  .how-it-works h2 {
    text-align: center;
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 3rem;
  }
  
  .steps {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
  }
  
  .step {
    text-align: center;
    padding: 1.5rem;
  }
  
  .step-number {
    width: 48px;
    height: 48px;
    background: #3b82f6;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.25rem;
    margin: 0 auto 1rem;
  }
  
  .step h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.5rem;
  }
  
  .step p {
    color: #6b7280;
    font-size: 0.875rem;
    line-height: 1.6;
  }
  
  @media (max-width: 768px) {
    .card-builder-hero h1 {
      font-size: 2rem;
    }
    
    .builder-options {
      grid-template-columns: 1fr;
      padding: 0 1rem;
    }
  }
</style>

<div class="pokemon-card-builder" id="card-builder">
  <div class="card-builder-hero">
    <h1>{{ section.settings.hero_title | default: 'Create Your Pokemon Card Collection' }}</h1>
    <p>{{ section.settings.hero_description | default: 'Build custom card collection pages and let customers buy individual cards or complete sets' }}</p>
  </div>
  
  <div class="builder-options">
    <div class="builder-option">
      <div class="option-preview preview-3x3">
        {% for i in (1..9) %}
          <div class="preview-card"></div>
        {% endfor %}
      </div>
      <h3 class="option-title">3x3 Collection</h3>
      <p class="option-description">Perfect for showcasing a curated set of 9 Pokemon cards in a clean, balanced layout.</p>
      <ul class="option-features">
        <li>9 card slots</li>
        <li>Individual buy buttons</li>
        <li>Collection bundle pricing</li>
        <li>Mobile responsive</li>
      </ul>
      <button class="create-page-btn" onclick="openPageBuilder('3x3')">
        Create 3x3 Collection Page
      </button>
    </div>
    
    <div class="builder-option">
      <div class="option-preview preview-4x3">
        {% for i in (1..12) %}
          <div class="preview-card"></div>
        {% endfor %}
      </div>
      <h3 class="option-title">4x3 Collection</h3>
      <p class="option-description">Ideal for larger collections with 12 cards, great for themed sets or evolution chains.</p>
      <ul class="option-features">
        <li>12 card slots</li>
        <li>Individual buy buttons</li>
        <li>Collection bundle pricing</li>
        <li>Compact mobile view</li>
      </ul>
      <button class="create-page-btn" onclick="openPageBuilder('4x3')">
        Create 4x3 Collection Page
      </button>
    </div>
  </div>
  
  {% if section.settings.show_instructions %}
    <div class="how-it-works">
      <h2>How It Works</h2>
      <div class="steps">
        <div class="step">
          <div class="step-number">1</div>
          <h3>Choose Layout</h3>
          <p>Select either a 3x3 or 4x3 grid layout based on your collection size and design preference.</p>
        </div>
        <div class="step">
          <div class="step-number">2</div>
          <h3>Create Page</h3>
          <p>Add a new page in your Shopify admin and insert the Pokemon card grid section.</p>
        </div>
        <div class="step">
          <div class="step-number">3</div>
          <h3>Add Products</h3>
          <p>Configure each card slot with your Pokemon card products from your inventory.</p>
        </div>
        <div class="step">
          <div class="step-number">4</div>
          <h3>Set Pricing</h3>
          <p>Individual cards show their own prices, plus set a bundle price for the complete collection.</p>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<div id="instructions-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; padding: 2rem;">
  <div style="background: white; max-width: 600px; margin: 2rem auto; padding: 2rem; border-radius: 16px; max-height: 80vh; overflow-y: auto;">
    <h3 id="modal-title">Create Collection Page</h3>
    <div id="modal-content"></div>
    <button onclick="closeInstructions()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; margin-top: 1rem;">Close</button>
  </div>
</div>

<!-- Full Screen Page Builder Modal -->
<div id="page-builder-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; overflow-y: auto;">
  <div class="page-builder-modal-content" style="width: 100%; min-height: 100%; background: white;">
    <div style="position: sticky; top: 0; background: white; z-index: 10001; padding: 1rem; border-bottom: 1px solid #e1e5e9; display: flex; justify-content: between; align-items: center;">
      <h2 style="margin: 0; font-size: 1.5rem;">Pokemon Collection Builder</h2>
      <button onclick="closePageBuilder()" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-left: auto;">
        Close Builder
      </button>
    </div>
    <div id="modal-page-builder">
      <!-- Page builder content will be loaded here -->
    </div>
  </div>
</div>

<script>
function openPageBuilder(layout) {
  console.log('openPageBuilder called with layout:', layout);
  
  const modal = document.getElementById('page-builder-modal');
  const content = document.getElementById('modal-page-builder');
  
  if (!modal) {
    console.error('Modal element not found!');
    alert('Error: Modal not found. Please refresh the page and try again.');
    return;
  }
  
  if (!content) {
    console.error('Modal content element not found!');
    alert('Error: Modal content not found. Please refresh the page and try again.');
    return;
  }
  
  console.log('Modal elements found, showing modal...');
  
  // Show the modal
  modal.style.display = 'block';
  document.body.style.overflow = 'hidden';
  
  // Load the page builder content
  loadPageBuilderContent(layout, content);
}

function closePageBuilder() {
  const modal = document.getElementById('page-builder-modal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
}

function loadPageBuilderContent(layout, container) {
  // Create the page builder HTML structure
  const pageBuilderHTML = `
    <div class="pokemon-page-builder" style="padding: 2rem;">
      <div class="page-builder-header" style="text-align: center; margin-bottom: 2rem;">
        <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">Create Your Pokemon Collection Page</h1>
        <p style="font-size: 1.1rem; color: #6b7280;">Build custom Pokemon card collection pages with our interactive builder</p>
      </div>

      <div class="page-builder-container" style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem; max-width: 1400px; margin: 0 auto;">
        <!-- Builder Controls -->
        <div class="builder-controls" style="background: rgba(255, 255, 255, 0.95); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); height: fit-content;">
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Page Layout:</label>
            <select id="pageLayout" style="width: 100%; padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px;">
              <option value="3x3" ${layout === '3x3' ? 'selected' : ''}>3x3 Grid (9 cards)</option>
              <option value="4x3" ${layout === '4x3' ? 'selected' : ''}>4x3 Grid (12 cards)</option>
              <option value="2x4">2x4 Grid (8 cards)</option>
            </select>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Page Title:</label>
            <input type="text" id="pageTitle" placeholder="My Pokemon Collection" maxlength="50" style="width: 100%; padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px;">
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Collection Theme:</label>
            <select id="collectionTheme" style="width: 100%; padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px;">
              <option value="classic">Classic</option>
              <option value="modern">Modern</option>
              <option value="vintage">Vintage</option>
              <option value="holographic">Holographic</option>
            </select>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <button id="toggleBrowser" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 1rem 2rem; border-radius: 12px; width: 100%; font-weight: 600; cursor: pointer;">
              🔍 Browse Pokemon Cards
            </button>
          </div>

          <div>
            <button id="clearAll" style="background: #f1f5f9; color: #475569; border: none; padding: 0.75rem 1rem; border-radius: 8px; margin-right: 0.5rem; cursor: pointer;">Clear All</button>
            <button id="saveCollection" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer;">Save</button>
          </div>
        </div>

        <!-- Main Builder Area -->
        <div class="builder-main" style="background: rgba(255, 255, 255, 0.95); border-radius: 12px; padding: 2rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);">
          <div class="preview-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #e1e5e9; padding-bottom: 1rem;">
            <h3 id="previewTitle" style="font-size: 1.8rem; margin: 0;">My Pokemon Collection</h3>
            <div>
              <button id="previewMode" style="padding: 0.5rem 1rem; border: 2px solid #e1e5e9; background: white; border-radius: 6px; margin-right: 0.5rem; cursor: pointer;">Preview</button>
              <button id="editMode" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: 2px solid #3b82f6; border-radius: 6px; cursor: pointer;">Edit</button>
            </div>
          </div>

          <!-- Dynamic Grid Container -->
          <div id="cardGrid" class="card-grid grid-${layout}" style="display: grid; gap: 1rem; margin-bottom: 2rem; padding: 1rem; background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: 12px; border: 2px dashed #cbd5e1; min-height: 400px; grid-template-columns: repeat(${layout === '4x3' ? '4' : layout === '2x4' ? '2' : '3'}, 1fr);">
            <!-- Grid slots will be generated dynamically -->
          </div>

          <!-- Pricing Section -->
          <div class="pricing-section" style="margin-top: 2rem;">
            <div style="background: linear-gradient(135deg, #fef3c7, #fbbf24); padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(251, 191, 36, 0.2);">
              <h3 style="text-align: center; margin-bottom: 1.5rem; color: #92400e;">Your Collection Pricing</h3>
              <div style="margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid rgba(146, 64, 14, 0.2);">
                  <span>Base Page Cost:</span>
                  <span id="baseCost">$15.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid rgba(146, 64, 14, 0.2);">
                  <span>Cards Selected:</span>
                  <span id="cardCount">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid rgba(146, 64, 14, 0.2);">
                  <span>Card Cost:</span>
                  <span id="cardCost">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem; padding-top: 1rem; border-top: 2px solid #92400e; margin-top: 0.5rem;">
                  <span>Total Cost:</span>
                  <span id="totalCost">$15.00</span>
                </div>
              </div>
              <button id="addToCart" style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1.2rem; font-weight: 600; cursor: pointer; width: 100%;" disabled>
                Add Collection to Cart
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  container.innerHTML = pageBuilderHTML;
  
  // Initialize the grid
  generateGrid(layout);
  
  // Add event listeners
  setupModalEventListeners();
}

function generateGrid(layout) {
  const grid = document.getElementById('cardGrid');
  let totalSlots;
  
  switch(layout) {
    case '3x3': totalSlots = 9; break;
    case '4x3': totalSlots = 12; break;
    case '2x4': totalSlots = 8; break;
    default: totalSlots = 9;
  }
  
  grid.innerHTML = '';
  
  for (let i = 0; i < totalSlots; i++) {
    const slot = document.createElement('div');
    slot.className = 'card-slot grid-slot';
    slot.dataset.slotIndex = i;
    slot.dataset.slot = \`slot-\${i}\`;
    slot.style.cssText = \`
      aspect-ratio: 2.5/3.5;
      background: white;
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    \`;
    
    slot.innerHTML = \`
      <div style="text-align: center; color: #94a3b8; font-size: 0.9rem;">
        <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;">🎴</div>
        <div>Click to select slot</div>
      </div>
    \`;
    
    slot.addEventListener('click', () => {
      console.log(\`Slot \${i + 1} clicked\`);
      
      // First, remove selection from all slots
      document.querySelectorAll('.grid-slot').forEach(s => {
        s.classList.remove('selected');
        s.style.borderColor = '#cbd5e1';
      });
      
      // Select this slot
      slot.classList.add('selected');
      slot.style.borderColor = '#3b82f6';
      slot.style.borderWidth = '3px';
      selectedSlot = \`slot-\${i}\`;
      
      console.log('Selected slot:', selectedSlot);
      
      // Update slot content to show it's selected
      slot.innerHTML = \`
        <div style="text-align: center; color: #3b82f6; font-size: 0.9rem;">
          <div style="font-size: 2rem; margin-bottom: 0.5rem;">✅</div>
          <div><strong>Slot \${i + 1} Selected</strong></div>
          <div style="font-size: 0.8rem; margin-top: 0.25rem;">Click "Browse Pokemon Cards"</div>
        </div>
      \`;
      
      // Show temporary message
      setTimeout(() => {
        if (slot.classList.contains('selected') && !slot.classList.contains('filled')) {
          slot.innerHTML = \`
            <div style="text-align: center; color: #3b82f6; font-size: 0.9rem;">
              <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.8;">🎯</div>
              <div>Selected Slot \${i + 1}</div>
            </div>
          \`;
        }
      }, 2000);
    });
    
    slot.addEventListener('mouseenter', () => {
      slot.style.borderColor = '#3b82f6';
      slot.style.background = '#f0f9ff';
      slot.style.transform = 'translateY(-2px)';
    });
    
    slot.addEventListener('mouseleave', () => {
      slot.style.borderColor = '#cbd5e1';
      slot.style.background = 'white';
      slot.style.transform = 'translateY(0)';
    });
    
    grid.appendChild(slot);
  }
}

function setupModalEventListeners() {
  // Layout change
  document.getElementById('pageLayout').addEventListener('change', (e) => {
    generateGrid(e.target.value);
    const grid = document.getElementById('cardGrid');
    const layout = e.target.value;
    grid.className = \`card-grid grid-\${layout}\`;
    grid.style.gridTemplateColumns = \`repeat(\${layout === '4x3' ? '4' : layout === '2x4' ? '2' : '3'}, 1fr)\`;
  });

  // Title change
  document.getElementById('pageTitle').addEventListener('input', (e) => {
    document.getElementById('previewTitle').textContent = e.target.value || 'My Pokemon Collection';
  });

  // Clear all
  document.getElementById('clearAll').addEventListener('click', () => {
    if (confirm('Clear all cards?')) {
      generateGrid(document.getElementById('pageLayout').value);
    }
  });

  // Save collection
  document.getElementById('saveCollection').addEventListener('click', () => {
    alert('Collection saved! This would save your collection data.');
  });

  // Add to cart
  document.getElementById('addToCart').addEventListener('click', () => {
    alert('Add to cart functionality would redirect to checkout here.');
  });

  // Browse cards - CRITICAL for Pokemon card selection
  const browserBtn = document.getElementById('toggleBrowser');
  if (browserBtn) {
    console.log('Found Browse Pokemon Cards button, adding event listener...');
    browserBtn.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('Browse Pokemon Cards button clicked!');
      
      // Check if user has selected a slot first
      if (!selectedSlot) {
        alert('Please select a grid slot first by clicking on one of the card slots in your collection grid.');
        return;
      }
      
      openPokemonBrowser();
    });
    console.log('Browse button listener added successfully');
  } else {
    console.error('Browse Pokemon Cards button not found!');
    
    // Debug: Let's see what elements we do have
    console.log('Available elements with IDs:', 
      Array.from(document.querySelectorAll('[id]')).map(el => el.id)
    );
  }
}

// Pokemon Card Browser Modal
function openPokemonBrowser() {
  console.log('openPokemonBrowser called');
  
  const existingModal = document.getElementById('pokemon-browser-modal');
  if (existingModal) {
    console.log('Found existing modal, showing it');
    existingModal.style.display = 'block';
    return;
  }
  
  console.log('Creating new Pokemon browser modal');
  
  const browserModalHTML = \`
    <div id="pokemon-browser-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10002; display: flex; align-items: center; justify-content: center;">
      <div style="background: white; width: 90%; max-width: 800px; height: 80%; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
        <div style="padding: 1rem; border-bottom: 1px solid #e1e5e9; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0;">Browse Pokemon Cards</h3>
          <button onclick="closePokemonBrowser()" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Close</button>
        </div>
        <div style="flex: 1; overflow: hidden;">
          <div id="pokemon-browser-content" style="height: 100%; overflow-y: auto;">
            <!-- Browser content will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  \`;
  
  document.body.insertAdjacentHTML('beforeend', browserModalHTML);
  loadPokemonBrowser();
}

function closePokemonBrowser() {
  const modal = document.getElementById('pokemon-browser-modal');
  if (modal) {
    modal.remove();
  }
}

function loadPokemonBrowser() {
  const content = document.getElementById('pokemon-browser-content');
  
  const browserHTML = \`
    <div class="pokemon-tcg-browser" style="padding: 1rem; height: 100%; display: flex; flex-direction: column;">
      <div class="browser-search" style="margin-bottom: 1rem;">
        <input type="text" id="modalCardSearch" placeholder="Search cards..." style="width: 100%; padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px;">
      </div>
      
      <div class="browser-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <button class="modal-tab-btn active" data-tab="eras" style="flex: 1; padding: 0.75rem; border: 2px solid #e1e5e9; background: #3b82f6; color: white; border-radius: 8px; cursor: pointer;">Eras</button>
        <button class="modal-tab-btn" data-tab="sets" style="flex: 1; padding: 0.75rem; border: 2px solid #e1e5e9; background: white; border-radius: 8px; cursor: pointer;">Sets</button>
        <button class="modal-tab-btn" data-tab="cards" style="flex: 1; padding: 0.75rem; border: 2px solid #e1e5e9; background: white; border-radius: 8px; cursor: pointer;">Cards</button>
      </div>
      
      <div class="browser-content" style="flex: 1; overflow-y: auto;">
        <div id="modalErasTab" class="modal-tab-content active">
          <div class="eras-grid" style="display: grid; gap: 0.5rem;">
            <div class="modal-era-item" data-era="vintage" style="padding: 1rem; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer;">
              <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">Vintage (1998-1999)</h4>
              <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Original Base Set era</p>
            </div>
            <div class="modal-era-item" data-era="neo" style="padding: 1rem; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer;">
              <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">Neo Series (2000-2001)</h4>
              <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Neo Genesis, Discovery, Destiny</p>
            </div>
            <div class="modal-era-item" data-era="ecard" style="padding: 1rem; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer;">
              <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">e-Card Series (2002-2003)</h4>
              <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Digital integration era</p>
            </div>
            <div class="modal-era-item" data-era="ex" style="padding: 1rem; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer;">
              <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">EX Series (2003-2007)</h4>
              <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Pokemon-ex introduction</p>
            </div>
            <div class="modal-era-item" data-era="dp" style="padding: 1rem; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer;">
              <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">Diamond & Pearl (2007-2009)</h4>
              <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Sinnoh region cards</p>
            </div>
            <div class="modal-era-item" data-era="hgss" style="padding: 1rem; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer;">
              <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">HeartGold SoulSilver (2009-2011)</h4>
              <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Johto region return</p>
            </div>
            <div class="modal-era-item" data-era="bw" style="padding: 1rem; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer;">
              <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">Black & White (2011-2013)</h4>
              <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Unova region cards</p>
            </div>
            <div class="modal-era-item" data-era="xy" style="padding: 1rem; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer;">
              <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">XY Series (2014-2016)</h4>
              <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Kalos region and Mega Evolution</p>
            </div>
            <div class="modal-era-item" data-era="sm" style="padding: 1rem; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer;">
              <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">Sun & Moon (2017-2019)</h4>
              <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Alola region and GX cards</p>
            </div>
            <div class="modal-era-item" data-era="swsh" style="padding: 1rem; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer;">
              <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">Sword & Shield (2020-2022)</h4>
              <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Galar region and V cards</p>
            </div>
            <div class="modal-era-item" data-era="sv" style="padding: 1rem; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer;">
              <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">Scarlet & Violet (2023+)</h4>
              <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Paldea region and current sets</p>
            </div>
          </div>
        </div>
        
        <div id="modalSetsTab" class="modal-tab-content" style="display: none;">
          <div class="modal-sets-loading" style="text-align: center; padding: 2rem; color: #6b7280;">
            <p>Select an era to view sets</p>
          </div>
          <div class="modal-sets-grid" style="display: none; gap: 0.75rem;"></div>
        </div>
        
        <div id="modalCardsTab" class="modal-tab-content" style="display: none;">
          <div class="modal-cards-loading" style="text-align: center; padding: 2rem; color: #6b7280;">
            <p>Select a set to view cards</p>
          </div>
          <div class="modal-cards-grid" style="display: none; gap: 0.75rem;"></div>
        </div>
      </div>
    </div>
  \`;
  
  content.innerHTML = browserHTML;
  initModalBrowser();
}

function initModalBrowser() {
  const API_KEY = '27cc9548-6ecd-4502-8b2d-267e2ef1bb61';
  const API_BASE = 'https://api.pokemontcg.io/v2';
  
  let currentEra = null;
  let currentSet = null;
  let selectedSlot = null;
  
  // Hardcoded set IDs for each era - much more reliable
  const eraSetIds = {
    vintage: [
      { id: 'base1', name: 'Base Set', description: 'The original Pokemon TCG set' },
      { id: 'base2', name: 'Jungle', description: 'Second set in the Base series' },
      { id: 'base3', name: 'Fossil', description: 'Third set featuring Fossil Pokemon' },
      { id: 'base4', name: 'Base Set 2', description: 'Reprint compilation set' },
      { id: 'base5', name: 'Team Rocket', description: 'First villain-themed set' },
      { id: 'gym1', name: 'Gym Heroes', description: 'Gym Leader Pokemon' },
      { id: 'gym2', name: 'Gym Challenge', description: 'More Gym Leader Pokemon' }
    ],
    neo: [
      { id: 'neo1', name: 'Neo Genesis', description: 'Introduction to Johto region' },
      { id: 'neo2', name: 'Neo Discovery', description: 'More Johto Pokemon' },
      { id: 'neo3', name: 'Neo Destiny', description: 'Light and Dark Pokemon' },
      { id: 'neo4', name: 'Neo Revelation', description: 'Legendary Pokemon focus' }
    ],
    ecard: [
      { id: 'ecard1', name: 'Expedition Base Set', description: 'First e-Card series' },
      { id: 'ecard2', name: 'Aquapolis', description: 'Water-themed e-Card set' },
      { id: 'ecard3', name: 'Skyridge', description: 'Final e-Card series set' }
    ],
    ex: [
      { id: 'ex1', name: 'Ruby & Sapphire', description: 'Hoenn region debut' },
      { id: 'ex2', name: 'Sandstorm', description: 'Desert-themed EX set' },
      { id: 'ex3', name: 'Dragon', description: 'Dragon-type introduction' },
      { id: 'ex4', name: 'Team Magma vs Team Aqua', description: 'Villain teams clash' },
      { id: 'ex5', name: 'Hidden Legends', description: 'Legendary Pokemon focus' },
      { id: 'ex6', name: 'FireRed & LeafGreen', description: 'Kanto region return' }
    ],
    dp: [
      { id: 'dp1', name: 'Diamond & Pearl', description: 'Sinnoh region introduction' },
      { id: 'dp2', name: 'Mysterious Treasures', description: 'Sinnoh Pokemon expansion' },
      { id: 'dp3', name: 'Secret Wonders', description: 'More Sinnoh discoveries' },
      { id: 'dp4', name: 'Great Encounters', description: 'Legendary encounters' },
      { id: 'dp5', name: 'Majestic Dawn', description: 'Dawn-themed set' },
      { id: 'dp6', name: 'Legends Awakened', description: 'Legendary Pokemon awaken' }
    ],
    hgss: [
      { id: 'hgss1', name: 'HeartGold & SoulSilver', description: 'Johto region return' },
      { id: 'hgss2', name: 'Unleashed', description: 'Pokemon power unleashed' },
      { id: 'hgss3', name: 'Undaunted', description: 'Fearless Pokemon battles' },
      { id: 'hgss4', name: 'Triumphant', description: 'Victory celebration set' },
      { id: 'col1', name: 'Call of Legends', description: 'Legendary Pokemon call' }
    ],
    bw: [
      { id: 'bw1', name: 'Black & White', description: 'Unova region debut' },
      { id: 'bw2', name: 'Emerging Powers', description: 'New powers emerge' },
      { id: 'bw3', name: 'Noble Victories', description: 'Noble Pokemon victories' },
      { id: 'bw4', name: 'Next Destinies', description: 'Destiny awaits' },
      { id: 'bw5', name: 'Dark Explorers', description: 'Dark Pokemon exploration' },
      { id: 'bw6', name: 'Dragons Exalted', description: 'Dragon Pokemon exalted' }
    ],
    xy: [
      { id: 'xy1', name: 'XY Base Set', description: 'Kalos region introduction' },
      { id: 'xy2', name: 'Flashfire', description: 'Fire-type focus' },
      { id: 'xy3', name: 'Furious Fists', description: 'Fighting-type emphasis' },
      { id: 'xy4', name: 'Phantom Forces', description: 'Ghostly Pokemon forces' },
      { id: 'xy5', name: 'Primal Clash', description: 'Primal Pokemon clash' },
      { id: 'xy6', name: 'Roaring Skies', description: 'Sky-high Pokemon battles' }
    ],
    sm: [
      { id: 'sm1', name: 'Sun & Moon Base Set', description: 'Alola region debut' },
      { id: 'sm2', name: 'Guardians Rising', description: 'Guardian Pokemon rise' },
      { id: 'sm3', name: 'Burning Shadows', description: 'Shadow Pokemon burn' },
      { id: 'sm4', name: 'Crimson Invasion', description: 'Crimson forces invade' },
      { id: 'sm5', name: 'Ultra Prism', description: 'Ultra Necrozma focus' },
      { id: 'sm6', name: 'Forbidden Light', description: 'Forbidden Pokemon light' }
    ],
    swsh: [
      { id: 'swsh1', name: 'Sword & Shield Base Set', description: 'Galar region introduction' },
      { id: 'swsh2', name: 'Rebel Clash', description: 'Rebellious Pokemon clash' },
      { id: 'swsh3', name: 'Darkness Ablaze', description: 'Dark flames ablaze' },
      { id: 'swsh4', name: 'Vivid Voltage', description: 'Electric energy surge' },
      { id: 'swsh5', name: 'Battle Styles', description: 'Different battle approaches' },
      { id: 'swsh6', name: 'Chilling Reign', description: 'Ice-cold Pokemon reign' }
    ],
    sv: [
      { id: 'sv1', name: 'Scarlet & Violet Base Set', description: 'Paldea region debut' },
      { id: 'sv2', name: 'Paldea Evolved', description: 'Paldean Pokemon evolution' },
      { id: 'sv3', name: 'Obsidian Flames', description: 'Obsidian fire burns' },
      { id: 'sv4', name: '151', description: 'Original 151 Pokemon celebration' },
      { id: 'sv5', name: 'Temporal Forces', description: 'Time-based Pokemon forces' }
    ]
  };
  
  // Tab switching
  document.querySelectorAll('.modal-tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const tabName = e.target.dataset.tab;
      switchModalTab(tabName);
    });
  });
  
  // Era selection
  document.querySelectorAll('.modal-era-item').forEach(item => {
    item.addEventListener('click', (e) => {
      const era = e.currentTarget.dataset.era;
      selectModalEra(era);
    });
    
    // Hover effects
    item.addEventListener('mouseenter', (e) => {
      e.target.style.borderColor = '#3b82f6';
      e.target.style.background = '#f0f9ff';
    });
    
    item.addEventListener('mouseleave', (e) => {
      e.target.style.borderColor = '#e1e5e9';
      e.target.style.background = 'white';
    });
  });
  
  function switchModalTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.modal-tab-btn').forEach(btn => {
      if (btn.dataset.tab === tabName) {
        btn.style.background = '#3b82f6';
        btn.style.color = 'white';
        btn.style.borderColor = '#3b82f6';
      } else {
        btn.style.background = 'white';
        btn.style.color = 'black';
        btn.style.borderColor = '#e1e5e9';
      }
    });
    
    // Update tab content
    document.querySelectorAll('.modal-tab-content').forEach(content => {
      content.style.display = content.id === 'modal' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab' ? 'block' : 'none';
    });
  }
  
  async function selectModalEra(era) {
    currentEra = era;
    switchModalTab('sets');
    
    const setsGrid = document.querySelector('.modal-sets-grid');
    const setsLoading = document.querySelector('.modal-sets-loading');
    
    setsLoading.innerHTML = '<div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 0.5rem;"></div>Loading sets...';
    setsLoading.style.display = 'block';
    setsGrid.style.display = 'none';
    
    try {
      console.log('Loading hardcoded sets for era:', era);
      
      // Get hardcoded sets for this era
      const eraSets = eraSetIds[era] || [];
      console.log('Found', eraSets.length, 'hardcoded sets for era:', era);
      
      if (eraSets.length === 0) {
        setsLoading.innerHTML = 'No sets available for this era yet.';
        return;
      }
      
      // Display the hardcoded sets immediately
      displayModalSetsFromHardcoded(eraSets);
      
    } catch (error) {
      console.error('Error loading sets:', error);
      setsLoading.innerHTML = \`Error loading sets: \${error.message}. Please try again.\`;
    }
  }
  
  function filterSetsByEra(allSets, era) {
    console.log('Filtering', allSets.length, 'sets for era:', era);
    console.log('Sample sets:', allSets.slice(0, 3));
    
    // Comprehensive era filtering based on series and set names from API data
    const eraFilters = {
      vintage: (set) => {
        const series = set.series?.toLowerCase() || '';
        const name = set.name?.toLowerCase() || '';
        const year = set.releaseDate ? parseInt(set.releaseDate.substring(0, 4)) : 0;
        return series === 'base' || 
               name.includes('base') || 
               name.includes('jungle') || 
               name.includes('fossil') ||
               name.includes('rocket') ||
               name.includes('gym') ||
               (year >= 1998 && year <= 2000);
      },
      
      neo: (set) => {
        const series = set.series?.toLowerCase() || '';
        const name = set.name?.toLowerCase() || '';
        const year = set.releaseDate ? parseInt(set.releaseDate.substring(0, 4)) : 0;
        return series.includes('neo') || 
               name.includes('neo') ||
               (year >= 2000 && year <= 2001);
      },
      
      ecard: (set) => {
        const series = set.series?.toLowerCase() || '';
        const name = set.name?.toLowerCase() || '';
        return series.includes('e-card') || 
               name.includes('e-card') || 
               name.includes('expedition') || 
               name.includes('aquapolis') || 
               name.includes('skyridge') ||
               (set.releaseDate && (set.releaseDate.startsWith('2002') || set.releaseDate.startsWith('2003')));
      },
      
      ex: (set) => {
        const series = set.series?.toLowerCase() || '';
        const name = set.name?.toLowerCase() || '';
        return series.includes('ex') || 
               name.includes('ex ') || 
               name.includes('ruby') || 
               name.includes('sapphire') || 
               name.includes('emerald') || 
               name.includes('firered') || 
               name.includes('leafgreen') ||
               (set.releaseDate && (parseInt(set.releaseDate.substring(0, 4)) >= 2003 && parseInt(set.releaseDate.substring(0, 4)) <= 2007));
      },
      
      dp: (set) => {
        const series = set.series?.toLowerCase() || '';
        const name = set.name?.toLowerCase() || '';
        return series.includes('diamond') || 
               series.includes('pearl') || 
               series.includes('platinum') || 
               name.includes('diamond') || 
               name.includes('pearl') || 
               name.includes('platinum') ||
               (set.releaseDate && (parseInt(set.releaseDate.substring(0, 4)) >= 2007 && parseInt(set.releaseDate.substring(0, 4)) <= 2009));
      },
      
      hgss: (set) => {
        const series = set.series?.toLowerCase() || '';
        const name = set.name?.toLowerCase() || '';
        return series.includes('heartgold') || 
               series.includes('soulsilver') || 
               name.includes('heartgold') || 
               name.includes('soulsilver') || 
               name.includes('call of legends') ||
               (set.releaseDate && (parseInt(set.releaseDate.substring(0, 4)) >= 2009 && parseInt(set.releaseDate.substring(0, 4)) <= 2011));
      },
      
      bw: (set) => {
        const series = set.series?.toLowerCase() || '';
        const name = set.name?.toLowerCase() || '';
        return series.includes('black') || 
               series.includes('white') || 
               name.includes('black') || 
               name.includes('white') || 
               name.includes('plasma') ||
               (set.releaseDate && (parseInt(set.releaseDate.substring(0, 4)) >= 2011 && parseInt(set.releaseDate.substring(0, 4)) <= 2013));
      },
      
      xy: (set) => {
        const series = set.series?.toLowerCase() || '';
        const name = set.name?.toLowerCase() || '';
        return series.includes('xy') || 
               name.includes('xy') || 
               name.includes('kalos') || 
               name.includes('flashfire') || 
               name.includes('furious') ||
               (set.releaseDate && (parseInt(set.releaseDate.substring(0, 4)) >= 2014 && parseInt(set.releaseDate.substring(0, 4)) <= 2016));
      },
      
      sm: (set) => {
        const series = set.series?.toLowerCase() || '';
        const name = set.name?.toLowerCase() || '';
        return series.includes('sun') || 
               series.includes('moon') || 
               name.includes('sun') || 
               name.includes('moon') || 
               name.includes('alola') || 
               name.includes('guardians') ||
               (set.releaseDate && (parseInt(set.releaseDate.substring(0, 4)) >= 2017 && parseInt(set.releaseDate.substring(0, 4)) <= 2019));
      },
      
      swsh: (set) => {
        const series = set.series?.toLowerCase() || '';
        const name = set.name?.toLowerCase() || '';
        return series.includes('sword') || 
               series.includes('shield') || 
               name.includes('sword') || 
               name.includes('shield') || 
               name.includes('rebel') || 
               name.includes('darkness') || 
               name.includes('vivid') || 
               name.includes('battle styles') ||
               (set.releaseDate && (parseInt(set.releaseDate.substring(0, 4)) >= 2020 && parseInt(set.releaseDate.substring(0, 4)) <= 2022));
      },
      
      sv: (set) => {
        const series = set.series?.toLowerCase() || '';
        const name = set.name?.toLowerCase() || '';
        return series.includes('scarlet') || 
               series.includes('violet') || 
               name.includes('scarlet') || 
               name.includes('violet') || 
               name.includes('paldea') ||
               (set.releaseDate && parseInt(set.releaseDate.substring(0, 4)) >= 2023);
      }
    };
    
    const filter = eraFilters[era];
    if (!filter) {
      console.error('No filter found for era:', era);
      return [];
    }
    
    const filtered = allSets.filter((set, index) => {
      const result = filter(set);
      if (index < 5) {
        console.log(\`Set \${index}: \${set.name} (series: \${set.series}, date: \${set.releaseDate}) -> \${result}\`);
      }
      return result;
    });
    
    console.log('Filtered to', filtered.length, 'sets for era:', era);
    console.log('Filtered sets:', filtered.map(s => s.name));
    
    // Sort by release date (newest first) and limit results
    return filtered
      .sort((a, b) => new Date(b.releaseDate) - new Date(a.releaseDate))
      .slice(0, 15); // Limit to 15 sets per era
  }
  
  function displayModalSetsFromHardcoded(eraSets) {
    const setsGrid = document.querySelector('.modal-sets-grid');
    const setsLoading = document.querySelector('.modal-sets-loading');
    
    console.log('Displaying hardcoded sets:', eraSets);
    
    setsGrid.innerHTML = eraSets.map(set => \`
      <div class="modal-set-item" data-set-id="\${set.id}" style="padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer; text-align: center;">
        <div style="width: 40px; height: 40px; margin: 0 auto 0.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem;">
          \${set.name.substring(0, 2).toUpperCase()}
        </div>
        <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">\${set.name}</h4>
        <p style="margin: 0 0 0.25rem 0; font-size: 0.8rem; color: #6b7280;">\${set.description}</p>
        <small style="font-size: 0.7rem; color: #9ca3af;">Click to view cards</small>
      </div>
    \`).join('');
    
    setsLoading.style.display = 'none';
    setsGrid.style.display = 'grid';
    
    // Add click listeners to sets
    document.querySelectorAll('.modal-set-item').forEach(item => {
      item.addEventListener('click', (e) => {
        const setId = e.currentTarget.dataset.setId;
        console.log('Selected set:', setId);
        selectModalSet(setId);
      });
      
      // Hover effects
      item.addEventListener('mouseenter', (e) => {
        e.currentTarget.style.borderColor = '#10b981';
        e.currentTarget.style.background = '#f0fdf4';
      });
      
      item.addEventListener('mouseleave', (e) => {
        e.currentTarget.style.borderColor = '#e1e5e9';
        e.currentTarget.style.background = 'white';
      });
    });
  }
  
  function displayModalSets(sets) {
    const setsGrid = document.querySelector('.modal-sets-grid');
    const setsLoading = document.querySelector('.modal-sets-loading');
    
    if (sets.length === 0) {
      setsLoading.innerHTML = 'No sets found for this era.';
      return;
    }
    
    setsGrid.innerHTML = sets.map(set => \`
      <div class="modal-set-item" data-set-id="\${set.id}" style="padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer; text-align: center;">
        <img src="\${set.images?.logo || set.images?.symbol}" alt="\${set.name}" style="width: 40px; height: 40px; margin-bottom: 0.5rem;">
        <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">\${set.name}</h4>
        <p style="margin: 0 0 0.25rem 0; font-size: 0.8rem; color: #6b7280;">\${set.releaseDate || 'Unknown date'}</p>
        <small style="font-size: 0.7rem; color: #9ca3af;">\${set.total || 0} cards</small>
      </div>
    \`).join('');
    
    setsLoading.style.display = 'none';
    setsGrid.style.display = 'grid';
    
    // Add click listeners to sets
    document.querySelectorAll('.modal-set-item').forEach(item => {
      item.addEventListener('click', (e) => {
        const setId = e.currentTarget.dataset.setId;
        selectModalSet(setId);
      });
      
      // Hover effects
      item.addEventListener('mouseenter', (e) => {
        e.currentTarget.style.borderColor = '#10b981';
        e.currentTarget.style.background = '#f0fdf4';
      });
      
      item.addEventListener('mouseleave', (e) => {
        e.currentTarget.style.borderColor = '#e1e5e9';
        e.currentTarget.style.background = 'white';
      });
    });
  }
  
  async function selectModalSet(setId) {
    currentSet = setId;
    switchModalTab('cards');
    
    const cardsGrid = document.querySelector('.modal-cards-grid');
    const cardsLoading = document.querySelector('.modal-cards-loading');
    
    cardsLoading.innerHTML = '<div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 0.5rem;"></div>Loading cards...';
    cardsLoading.style.display = 'block';
    cardsGrid.style.display = 'none';
    
    try {
      const response = await fetch(\`\${API_BASE}/cards?q=set.id:\${setId}&pageSize=50\`, {
        headers: { 'X-Api-Key': API_KEY }
      });
      
      const data = await response.json();
      displayModalCards(data.data || []);
    } catch (error) {
      console.error('Error fetching cards:', error);
      cardsLoading.innerHTML = 'Error loading cards. Please try again.';
    }
  }
  
  function displayModalCards(cards) {
    const cardsGrid = document.querySelector('.modal-cards-grid');
    const cardsLoading = document.querySelector('.modal-cards-loading');
    
    if (cards.length === 0) {
      cardsLoading.innerHTML = 'No cards found in this set.';
      return;
    }
    
    cardsGrid.innerHTML = cards.map(card => \`
      <div class="modal-card-item" data-card-data='\${JSON.stringify(card)}' style="display: flex; flex-direction: column; align-items: center; padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer;">
        <img src="\${card.images?.small}" alt="\${card.name}" loading="lazy" style="width: 80px; height: auto; border-radius: 4px; margin-bottom: 0.5rem;">
        <h5 style="margin: 0 0 0.25rem 0; font-size: 0.8rem; font-weight: 600; text-align: center;">\${card.name}</h5>
        <small style="font-size: 0.7rem; color: #6b7280;">\${card.number}/\${card.set.total}</small>
      </div>
    \`).join('');
    
    cardsLoading.style.display = 'none';
    cardsGrid.style.display = 'grid';
    
    // Add click listeners to cards
    document.querySelectorAll('.modal-card-item').forEach(item => {
      item.addEventListener('click', (e) => {
        const cardData = JSON.parse(e.currentTarget.dataset.cardData);
        selectModalCard(cardData);
      });
      
      // Hover effects
      item.addEventListener('mouseenter', (e) => {
        e.currentTarget.style.borderColor = '#10b981';
        e.currentTarget.style.background = '#f0fdf4';
      });
      
      item.addEventListener('mouseleave', (e) => {
        e.currentTarget.style.borderColor = '#e1e5e9';
        e.currentTarget.style.background = 'white';
      });
    });
  }
  
  function selectModalCard(cardData) {
    console.log('Selected card:', cardData);
    
    // Check if we have a selected slot
    if (!selectedSlot) {
      alert('Please select a grid slot first, then choose a card to add to it.');
      return;
    }
    
    // Add the card to the selected slot
    const slotElement = document.querySelector(\`[data-slot="\${selectedSlot}"]\`);
    if (slotElement) {
      // Update the slot with the card image and data
      slotElement.innerHTML = \`
        <img src="\${cardData.images?.small || cardData.images?.large}" alt="\${cardData.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
        <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; background: rgba(0,0,0,0.8); color: white; padding: 2px 4px; border-radius: 4px; font-size: 0.7rem; text-align: center;">
          \${cardData.name}
        </div>
      \`;
      
      // Store card data on the element
      slotElement.dataset.cardData = JSON.stringify(cardData);
      slotElement.classList.add('filled');
      
      // Clear selected slot
      document.querySelectorAll('.grid-slot').forEach(slot => {
        slot.classList.remove('selected');
      });
      selectedSlot = null;
      
      alert(\`Added \${cardData.name} to your collection!\`);
    }
    
    closePokemonBrowser();
  }
}

// Add CSS animation for spinner
const style = document.createElement('style');
style.textContent = \`
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
\`;
document.head.appendChild(style);

// Close modal when clicking outside
document.getElementById('page-builder-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closePageBuilder();
  }
});
</script>

{% schema %}
{
  "name": "Pokemon Card Builder",
  "settings": [
    {
      "type": "text",
      "id": "hero_title",
      "label": "Hero Title",
      "default": "Create Your Pokemon Card Collection"
    },
    {
      "type": "textarea",
      "id": "hero_description",
      "label": "Hero Description",
      "default": "Build custom card collection pages and let customers buy individual cards or complete sets"
    },
    {
      "type": "checkbox",
      "id": "show_instructions",
      "label": "Show 'How It Works' section",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Pokemon Card Builder"
    }
  ]
}
{% endschema %}